name: AI News Analyzer

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max_topics:
        description: 'æœ€å¤§åˆ†æè¯é¢˜æ•°'
        required: false
        default: '20'
        type: choice
        options:
          - 10
          - 20
          - 30
          - 50

# æƒé™é…ç½®
permissions:
  contents: write

# æ³¨é‡Šï¼šPages éƒ¨ç½²å·²ç¦ç”¨ï¼Œå› ä¸ºæŠ¥å‘Šå·²é€šè¿‡ Artifactsã€Git æäº¤å’Œ Releases æä¾›è®¿é—®
# å¦‚éœ€å¯ç”¨ Pagesï¼Œè¯·ç¡®ä¿åœ¨ä»“åº“è®¾ç½®ä¸­æ­£ç¡®é…ç½® GitHub Pages

jobs:
  analyze-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: åˆ›å»º reports ç›®å½•
        run: |
          mkdir -p skills/ai-news-analyzer/reports

      - name: éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."
          if [ -z "${{ secrets.TIANAPI_KEY }}" ]; then
            echo "âŒ é”™è¯¯: TIANAPI_KEY æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­æ·»åŠ  TIANAPI_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.ZHIPU_API_KEY }}" ]; then
            echo "âŒ é”™è¯¯: ZHIPU_API_KEY æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­æ·»åŠ  ZHIPU_API_KEY"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®"

      - name: è¿è¡Œ AI æ–°é—»åˆ†æï¼ˆæ™ºè°± GLM-4.7ï¼‰
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          node .github/scripts/ai-news-analyzer-zhipu.js

      - name: ç”Ÿæˆ HTML æŠ¥å‘Š
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
        run: |
          node skills/ai-news-analyzer/get-daily-news.js

      - name: ä¸Šä¼ æŠ¥å‘Šåˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-news-report-${{ github.run_number }}
          path: skills/ai-news-analyzer/reports/*.html
          retention-days: 30

      - name: æäº¤æŠ¥å‘Šåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # ä½¿ç”¨ -f å¼ºåˆ¶æ·»åŠ è¢« .gitignore å¿½ç•¥çš„ HTML æŠ¥å‘Šæ–‡ä»¶
          git add -f skills/ai-news-analyzer/reports/*.html
          git diff --staged --quiet || git commit -m "ğŸ¤– AI News Report - $(date +'%Y-%m-%d')"
          git push

      - name: åˆ›å»º GitHub Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="report-$(date +'%Y-%m-%d')"
          RELEASE_NAME="AI News Report - $(date +'%Y-%m-%d')"

          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping release creation"
            exit 0
          fi

          # è·å–æœ€æ–°çš„ HTML æŠ¥å‘Š
          LATEST_REPORT=$(ls -t skills/ai-news-analyzer/reports/*.html | head -1)

          # åˆ›å»º tag
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

          # åˆ›å»º release å¹¶ä¸Šä¼ æŠ¥å‘Š
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "Automated AI News Analysis Report generated on $(date +'%Y-%m-%d')" \
            "$LATEST_REPORT"
