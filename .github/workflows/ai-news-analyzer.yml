name: AI News Analyzer

on:
  # ÂÆöÊó∂ÊâßË°åÔºöÊØèÂ§©Âåó‰∫¨Êó∂Èó¥ 9:00 (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'

  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      max_topics:
        description: 'ÊúÄÂ§ßÂàÜÊûêËØùÈ¢òÊï∞'
        required: false
        default: '20'
        type: choice
        options:
          - 10
          - 20
          - 30
          - 50

# ÊùÉÈôêÈÖçÁΩÆ
permissions:
  contents: write
  pages: write
  id-token: write

# GitHub Pages ÈÖçÁΩÆ
# ÂøÖÈ°ªÂú®‰ªìÂ∫ìËÆæÁΩÆ‰∏≠ÂêØÁî® GitHub PagesÔºåÂπ∂ÈÄâÊã© GitHub Actions ‰Ωú‰∏∫Ê∫ê

jobs:
  analyze-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ÂàõÂª∫ reports ÁõÆÂΩï
        run: |
          mkdir -p skills/ai-news-analyzer/reports

      - name: È™åËØÅÁéØÂ¢ÉÂèòÈáè
        run: |
          echo "Ê£ÄÊü•ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ..."
          if [ -z "${{ secrets.TIANAPI_KEY }}" ]; then
            echo "‚ùå ÈîôËØØ: TIANAPI_KEY Êú™ËÆæÁΩÆ"
            echo "ËØ∑Âú® GitHub Secrets ‰∏≠Ê∑ªÂä† TIANAPI_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.ZHIPU_API_KEY }}" ]; then
            echo "‚ùå ÈîôËØØ: ZHIPU_API_KEY Êú™ËÆæÁΩÆ"
            echo "ËØ∑Âú® GitHub Secrets ‰∏≠Ê∑ªÂä† ZHIPU_API_KEY"
            exit 1
          fi
          echo "‚úÖ ÊâÄÊúâÂøÖÈúÄÁöÑÁéØÂ¢ÉÂèòÈáèÈÉΩÂ∑≤ËÆæÁΩÆ"

      - name: ËøêË°å AI Êñ∞ÈóªÂàÜÊûêÔºàÊô∫Ë∞± GLM-4.7Ôºâ
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          node .github/scripts/ai-news-analyzer-zhipu.js

      - name: ÁîüÊàê HTML Êä•Âëä
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
        run: |
          node skills/ai-news-analyzer/get-daily-news.js

      - name: ‰∏ä‰º†Êä•ÂëäÂà∞ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-news-report-${{ github.run_number }}
          path: skills/ai-news-analyzer/reports/*.html
          retention-days: 30

      - name: Êèê‰∫§Êä•ÂëäÂà∞‰ªìÂ∫ì
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # ‰ΩøÁî® -f Âº∫Âà∂Ê∑ªÂä†Ë¢´ .gitignore ÂøΩÁï•ÁöÑ HTML Êä•ÂëäÊñá‰ª∂
          git add -f skills/ai-news-analyzer/reports/*.html
          git diff --staged --quiet || git commit -m "ü§ñ AI News Report - $(date +'%Y-%m-%d')"
          # ÂÖàÊãâÂèñËøúÁ®ãÊõ¥Êñ∞Âπ∂rebaseÔºåÈÅøÂÖçÂÜ≤Á™Å
          git pull --rebase --autostash || true
          git push

      - name: ÂàõÂª∫ GitHub Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="report-$(date +'%Y-%m-%d')"
          RELEASE_NAME="AI News Report - $(date +'%Y-%m-%d')"

          # Ê£ÄÊü• tag ÊòØÂê¶Â∑≤Â≠òÂú®
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping release creation"
            exit 0
          fi

          # Ëé∑ÂèñÊúÄÊñ∞ÁöÑ HTML Êä•Âëä
          LATEST_REPORT=$(ls -t skills/ai-news-analyzer/reports/*.html | head -1)

          # ÂàõÂª∫ tag
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

          # ÂàõÂª∫ release Âπ∂‰∏ä‰º†Êä•Âëä
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "Automated AI News Analysis Report generated on $(date +'%Y-%m-%d')" \
            "$LATEST_REPORT"

  # ÈÉ®ÁΩ≤Âà∞ GitHub Pages
  deploy-pages:
    needs: analyze-news
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout ‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ‰∏ãËΩΩÊä•Âëä Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ai-news-report-*
          path: _pages/reports
          merge-multiple: true

      - name: ÁßªÂä®Êä•ÂëäÊñá‰ª∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
        run: |
          # ÊâÅÂπ≥ÂåñÁõÆÂΩïÁªìÊûÑÔºöÂ∞ÜÊâÄÊúâÂ≠êÁõÆÂΩï‰∏≠ÁöÑHTMLÊñá‰ª∂ÁßªÂä®Âà∞ _pages/reports/ Ê†πÁõÆÂΩï
          find _pages/reports -mindepth 2 -name "*.html" -type f -exec mv -t _pages/reports/ {} +
          # Âà†Èô§Á©∫ÁöÑÂ≠êÁõÆÂΩï
          find _pages/reports -mindepth 1 -type d -empty -delete

      - name: ÂàõÂª∫È¶ñÈ°µ
        run: |
          cat > _pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI News Analyzer Reports</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                                   'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 16px;
                      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                      overflow: hidden;
                  }
                  .header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  .header h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                      font-weight: 700;
                  }
                  .content {
                      padding: 40px;
                  }
                  .report-list {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                      gap: 20px;
                      margin-top: 20px;
                  }
                  .report-card {
                      border: 1px solid #e0e0e0;
                      border-radius: 8px;
                      padding: 20px;
                      transition: all 0.3s ease;
                      cursor: pointer;
                  }
                  .report-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                  }
                  .report-card h3 {
                      color: #667eea;
                      margin-bottom: 10px;
                  }
                  .report-card p {
                      color: #666;
                      font-size: 0.9em;
                  }
                  .footer {
                      background: #f5f5f5;
                      padding: 30px;
                      text-align: center;
                      color: #666;
                      border-top: 1px solid #e0e0e0;
                  }
                  @media (max-width: 768px) {
                      .header h1 {
                          font-size: 1.8em;
                      }
                      .content {
                          padding: 20px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ü§ñ AI News Analyzer</h1>
                      <p>AIË°å‰∏öËµÑËÆØÂàÜÊûêÊä•Âëä</p>
                  </div>
                  <div class="content">
                      <h2>üìä ÊúÄÊñ∞Êä•Âëä</h2>
                      <div class="report-list" id="reportList">
                          <p>Âä†ËΩΩ‰∏≠...</p>
                      </div>
                  </div>
                  <div class="footer">
                      <p>Generated with <a href="https://claude.com/claude-code" target="_blank">Claude Code</a></p>
                  </div>
              </div>
              <script>
                  fetch('reports/')
                      .then(response => response.text())
                      .then(text => {
                          const parser = new DOMParser();
                          const doc = parser.parseFromString(text, 'text/html');
                          const links = Array.from(doc.querySelectorAll('a'))
                              .map(a => a.href)
                              .filter(href => href.endsWith('.html'));
                          const reportList = document.getElementById('reportList');
                          if (links.length > 0) {
                              reportList.innerHTML = links
                                  .sort((a, b) => b.localeCompare(a))
                                  .map(href => {
                                      const name = href.split('/').pop().replace(/-/g, ' ').replace('.html', '');
                                      return `
                                          <a href="${href}" style="text-decoration: none;">
                                              <div class="report-card">
                                                  <h3>üìÑ ${name}</h3>
                                                  <p>ÁÇπÂáªÊü•ÁúãÊä•Âëä</p>
                                              </div>
                                          </a>
                                      `;
                                  })
                                  .join('');
                          } else {
                              reportList.innerHTML = '<p>ÊöÇÊó†Êä•Âëä</p>';
                          }
                      })
                      .catch(() => {
                          document.getElementById('reportList').innerHTML = '<p>Âä†ËΩΩÂ§±Ë¥•</p>';
                      });
              </script>
          </body>
          </html>
          EOF

      - name: ‰∏ä‰º†Âà∞ GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _pages

      - name: ÈÉ®ÁΩ≤Âà∞ GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
