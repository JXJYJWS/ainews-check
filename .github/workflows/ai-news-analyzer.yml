name: AI News Analyzer

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max_topics:
        description: 'æœ€å¤§åˆ†æžè¯é¢˜æ•°'
        required: false
        default: '20'
        type: choice
        options:
          - 10
          - 20
          - 30
          - 50

# æƒé™é…ç½®
permissions:
  contents: write
  pages: write
  id-token: write

# å¹¶å‘æŽ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  analyze-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: åˆ›å»º reports ç›®å½•
        run: |
          mkdir -p skills/ai-news-analyzer/reports

      - name: è¿è¡Œ AI æ–°é—»åˆ†æžï¼ˆæ™ºè°± GLM-4.7ï¼‰
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          node .github/scripts/ai-news-analyzer-zhipu.js

      - name: ç”Ÿæˆ HTML æŠ¥å‘Š
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          TIANAPI_ENDPOINT: ${{ secrets.TIANAPI_ENDPOINT || 'https://apis.tianapi.com/ai/index' }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '20' }}
        run: |
          node skills/ai-news-analyzer/get-daily-news.js

      - name: ä¸Šä¼ æŠ¥å‘Šåˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-news-report-${{ github.run_number }}
          path: skills/ai-news-analyzer/reports/*.html
          retention-days: 30

      - name: æäº¤æŠ¥å‘Šåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add skills/ai-news-analyzer/reports/*.html
          git diff --staged --quiet || git commit -m "ðŸ¤– AI News Report - $(date +'%Y-%m-%d')"
          git push

      - name: åˆ›å»º GitHub Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="report-$(date +'%Y-%m-%d')"
          RELEASE_NAME="AI News Report - $(date +'%Y-%m-%d')"

          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping release creation"
            exit 0
          fi

          # èŽ·å–æœ€æ–°çš„ HTML æŠ¥å‘Š
          LATEST_REPORT=$(ls -t skills/ai-news-analyzer/reports/*.html | head -1)

          # åˆ›å»º tag
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

          # åˆ›å»º release å¹¶ä¸Šä¼ æŠ¥å‘Š
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "Automated AI News Analysis Report generated on $(date +'%Y-%m-%d')" \
            "$LATEST_REPORT"

  # å¯é€‰ï¼šéƒ¨ç½²åˆ° GitHub Pages
  deploy-pages:
    if: success()
    needs: analyze-news
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰ reports
        uses: actions/download-artifact@v4
        with:
          path: skills/ai-news-analyzer/reports

      - name: è®¾ç½® Pages
        uses: actions/configure-pages@v4

      - name: åˆ›å»º Pages ç«™ç‚¹
        run: |
          mkdir -p pages
          cp skills/ai-news-analyzer/reports/*/*.html pages/ || true

          # åˆ›å»ºç´¢å¼•é¡µ
          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI News Reports</title>
              <style>
                  body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
                  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 12px; margin-bottom: 30px; }
                  .header h1 { margin: 0; }
                  .report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
                  .report-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.3s; }
                  .report-card:hover { transform: translateY(-5px); }
                  .report-date { font-size: 0.9em; color: #666; margin-bottom: 10px; }
                  .report-link { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; }
                  .report-link:hover { background: #764ba2; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸ¤– AI News Analysis Reports</h1>
                  <p>Powered by Zhipu GLM-4.7</p>
              </div>
              <div class="report-grid">
                  $(find skills/ai-news-analyzer/reports -name "*.html" -type f | sort -r | head -20 | while read file; do
                      filename=$(basename "$file")
                      date=$(echo "$filename" | grep -oP '\d{4}-\d{2}-\d{2}' || echo "Unknown Date")
                      echo "<div class='report-card'>"
                      echo "<div class='report-date'>ðŸ“… $date</div>"
                      echo "<h3>AI News Report</h3>"
                      echo "<a href='$filename' class='report-link'>View Report</a>"
                      echo "</div>"
                  done)
              </div>
          </body>
          </html>
          EOF

      - name: ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
